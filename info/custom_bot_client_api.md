# Custom Bot Client API (Local Engine Interface) (Draft)

This document specifies the public, language-agnostic interface between a **custom bot client** (networking + orchestration) and a **local bot engine** (decision making).

The engine:

- does **not** speak WebSocket / HTTP
- reads a single JSON request from stdin
- writes a single JSON response to stdout
- may write logs to stderr

For the server protocol and state formats, see `info/custom_bot_protocol.md`.

## Terminology

- **Server**: Wallgame backend.
- **Custom bot client**: a user-run program that connects to the server and controls a single seat using a `seatToken`.
- **Engine**: a local executable/script that makes decisions given a request.
- **Request**: one decision prompt (move, draw decision, rematch decision).

## Custom Bot Client CLI

This doc is primarily about the engine API, but most client implementations will expose a CLI similar to:

```bash
wallgame-bot-client \
  --server https://wallgame.example \
  --token <seatToken> \
  --engine "<command to run your engine>"
```

Flags:

- `--server <url>`: base URL used to derive the WebSocket URL (default: `http://localhost:5173` in dev).
- `--token <seatToken>`: required; the per-seat token from the UI.
- `--engine <command>`: optional; if omitted, the client MAY run a built-in "dumb bot".
- `--log-level <level>`: optional (`debug|info|warn|error`).

## Engine Execution Model

For each decision prompt, the client starts the engine as a new process:

1. spawn engine process
2. write exactly one JSON object to engine stdin
3. close engine stdin
4. read engine stdout until EOF
5. parse exactly one JSON object from stdout
6. kill the engine if it exceeds a client-defined timeout (based on clock time left)

Engines MUST be treated as untrusted.

## Wire format (Client <-> Engine)

- Encoding: UTF-8.
- Engine stdin: exactly one JSON object.
- Engine stdout: exactly one JSON object (whitespace allowed around it).
- Engines SHOULD write logs to stderr, not stdout.

If the engine writes invalid JSON or no JSON to stdout, the client will treat it as a failed decision (implementation-defined fallback).

## Engine API Version

The engine API is versioned independently, but in v1 it intentionally matches the server protocol version:

- `engineApiVersion: 1`

Clients MUST include `engineApiVersion` in requests. Engines MUST reject unknown versions.

## Common types

### `SerializedGameState`

Requests embed the canonical `SerializedGameState` object from the server protocol. See `info/custom_bot_protocol.md` for full details.

## Requests

All requests share these fields:

```json
{
  "engineApiVersion": 1,
  "kind": "move",
  "requestId": "...",
  "server": {
    "matchId": "...",
    "gameId": "abcd1234",
    "serverTime": 1735264000456
  },
  "seat": { "role": "host", "playerId": 1 },
  "state": { "...": "..." }
}
```

- `requestId` is generated by the client and MUST be echoed back in the response.
- `server.serverTime` is the server's time in ms since epoch from the triggering server message (useful for clock math).

### `kind: "move"`

Sent when it is the bot's turn and a move (or equivalent action) is expected.

```json
{
  "engineApiVersion": 1,
  "kind": "move",
  "requestId": "...",
  "server": { "matchId": "...", "gameId": "abcd1234", "serverTime": 1735264000456 },
  "seat": { "role": "host", "playerId": 1 },
  "turn": {
    "turnRequestId": "...",
    "expectedMoveCount": 12,
    "allowedActions": ["move", "resign"]
  },
  "state": { "...": "..." }
}
```

Notes:

- `turn.expectedMoveCount` equals `state.moveCount`.
- For `kind: "move"`, the engine may return either `action.kind: "move"` or `action.kind: "resign"`.
- Draw offers are delivered separately as `kind: "draw"` requests, and do not block play.

### `kind: "draw" | "rematch"`

Sent when the custom bot client receives an offer from the server and chooses to ask the engine for a decision.

Draw offers are advisory and do not block play. The client is NOT required to consult the engine (or respond to the server) for every offer.

Draw offer request:

```json
{
  "engineApiVersion": 1,
  "kind": "draw",
  "requestId": "...",
  "server": { "matchId": "...", "gameId": "abcd1234", "serverTime": 1735264000123 },
  "seat": { "role": "host", "playerId": 1 },
  "drawOffer": { "offerId": "...", "offeredBy": 2, "moveCount": 12 },
  "state": { "...": "..." }
}
```

Notes:

- `drawOffer.moveCount` matches `state.moveCount` at the time the offer was delivered.
- If the client receives a `state` update with a higher `moveCount` while the engine is evaluating this request, the engine result MUST be discarded and no server response should be sent for the expired offer.

Rematch offer:

```json
{
  "engineApiVersion": 1,
  "kind": "rematch",
  "requestId": "...",
  "server": { "matchId": "...", "gameId": "abcd1234", "serverTime": 1735264000123 },
  "seat": { "role": "host", "playerId": 1 },
  "rematchOffer": { "offerId": "...", "offeredBy": 2, "gameId": "abcd1234" },
  "state": { "...": "..." }
}
```

## Responses

All responses MUST include `engineApiVersion` and MUST echo `requestId`.

Response rule:

- If the request `kind` is `draw` or `rematch`, the response `action.kind` MUST match the request kind and MUST echo the offer id (`offerId`), so clients can safely validate and forward it.

### Move response

```json
{
  "engineApiVersion": 1,
  "requestId": "...",
  "action": { "kind": "move", "moveNotation": "Ce4.Md5.>f3" }
}
```

- `moveNotation` uses standard move notation (`info/custom_bot_protocol.md`).
- Use `---` for a pass move.

### Resign response

```json
{
  "engineApiVersion": 1,
  "requestId": "...",
  "action": { "kind": "resign" }
}
```

### Draw / Rematch decision response

```json
{
  "engineApiVersion": 1,
  "requestId": "...",
  "action": { "kind": "draw", "offerId": "...", "decision": "accept" }
}
```

Valid `decision` values: `accept` | `decline`.

For rematch:

```json
{
  "engineApiVersion": 1,
  "requestId": "...",
  "action": { "kind": "rematch", "offerId": "...", "gameId": "abcd1234", "decision": "accept" }
}
```

## Error handling (Engine-side)

Engines SHOULD fail fast and clearly:

- If the request is unsupported, write a valid JSON response with `action.kind: "resign"` (or a deterministic safe default) rather than emitting invalid JSON.
- Write human-readable diagnostics to stderr.

Client implementations MAY provide their own fallback strategy if the engine crashes, times out, or produces invalid output.
